<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×–×™×”×•×™ ×ª×–×•× ×” ××ª××•× ×” - AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 25px;
        }
        
        .api-key-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .api-key-section label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .api-key-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .api-key-section input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .api-key-section p {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }
        
        .upload-section {
            text-align: center;
            padding: 40px;
            border: 3px dashed #667eea;
            border-radius: 15px;
            background: #f8f9fa;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }
        
        .upload-section.dragover {
            background: #e8eaf6;
            border-color: #764ba2;
        }
        
        .upload-section input[type="file"] {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .upload-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .preview-section {
            margin-top: 25px;
            text-align: center;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .analyze-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }
        
        .analyze-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #667eea;
            font-size: 1.2rem;
        }
        
        .results-section {
            margin-top: 25px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .results-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .nutrition-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .nutrition-item label {
            display: block;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .nutrition-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .ai-description {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .ai-description h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .save-section {
            margin-top: 25px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 10px;
            text-align: center;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }
        
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 4px solid #2196F3;
        }
        
        .info-box p {
            color: #1565c0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– ×–×™×”×•×™ ×ª×–×•× ×” ××ª××•× ×” - AI</h1>
            <p>×”×¢×œ×” ×ª××•× ×” ×©×œ ×”××•×›×œ ×©×œ×š ×•×§×‘×œ ×”×¢×¨×›×” ×©×œ ×”×¢×¨×›×™× ×”×ª×–×•× ×ª×™×™×</p>
        </div>
        
        <div class="main-card">
            <div class="info-box">
                <p><strong>â„¹ï¸ ×”×•×¨××•×ª:</strong></p>
                <p style="margin-top: 10px;">
                    <strong>ğŸ ××¤×©×¨×•×ª ×—×™× ××™×ª:</strong> Google Gemini API - ×—×™× ××™ ×œ×—×œ×•×˜×™×Ÿ ×¢× ××›×¡×” ×™×•××™×ª!
                </p>
                <ol style="margin-right: 20px; margin-top: 10px; line-height: 1.8;">
                    <li>×”×™×›× ×¡ ×œ-<a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #1976D2; text-decoration: underline; font-weight: bold;">Google AI Studio</a></li>
                    <li>×œ×—×¥ ×¢×œ "Get API Key" (××• "Create API Key")</li>
                    <li>×”×¢×ª×§ ××ª ×”××¤×ª×— ×•×”×“×‘×§ ×›××Ÿ ×œ××˜×”</li>
                    <li><strong>×—×™× ××™ ×œ×—×œ×•×˜×™×Ÿ!</strong> ××›×¡×” ×™×•××™×ª ×©×œ 15 requests per minute</li>
                </ol>
                <p style="margin-top: 10px; color: #1565c0;">
                    <strong>××•:</strong> ×× ×™×© ×œ×š ChatGPT Plus, ×ª×•×›×œ ×œ×”×©×ª××© ×‘-OpenAI API (×“×•×¨×© ×ª×©×œ×•× × ×¤×¨×“)
                </p>
            </div>
            
            <div class="api-key-section">
                <label for="providerSelect" style="display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50; font-size: 1.1rem;">ğŸ”Œ ×‘×—×¨ ×¡×¤×§ AI:</label>
                <select id="providerSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; margin-bottom: 20px;" onchange="toggleProviderFields()">
                    <option value="gemini">ğŸ†“ Google Gemini (×—×™× ××™ ×œ×—×œ×•×˜×™×Ÿ!)</option>
                    <option value="openai">OpenAI (×“×•×¨×© ×ª×©×œ×•×)</option>
                </select>
                
                <div id="geminiSection">
                    <label for="geminiApiKey">ğŸ”‘ ××¤×ª×— Google Gemini API:</label>
                    <input type="password" id="geminiApiKey" placeholder="AIza..." />
                    <p style="font-size: 0.85rem; color: #2e7d32; margin-top: 8px;">
                        âœ… ×—×™× ××™ ×œ×—×œ×•×˜×™×Ÿ! ××›×¡×”: 15 requests per minute
                    </p>
                </div>
                
                <div id="openaiSection" style="display: none;">
                    <label for="openaiApiKey">ğŸ”‘ ××¤×ª×— OpenAI API:</label>
                    <input type="password" id="openaiApiKey" placeholder="sk-..." />
                    <div style="margin-top: 15px;">
                        <label for="modelSelect" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">ğŸ¤– ×‘×—×¨ ××•×“×œ AI:</label>
                        <select id="modelSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="gpt-4o">GPT-4o (××“×•×™×§ ×™×•×ª×¨, ×™×§×¨ ×™×•×ª×¨)</option>
                            <option value="gpt-4o-mini">GPT-4o-mini (××™×–×•×Ÿ ×˜×•×‘, ×–×•×œ ×™×•×ª×¨)</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo (××™×›×•×ª ×’×‘×•×”×”)</option>
                        </select>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                            ğŸ’¡ ×˜×™×¤: ×× ×—×¨×’×ª ××”××›×¡×”, × ×¡×” GPT-4o-mini (×–×•×œ ×™×•×ª×¨)
                        </p>
                    </div>
                </div>
                
                <button onclick="saveApiKey()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 15px;">
                    ×©××•×¨ ××¤×ª×—
                </button>
                <p style="margin-top: 10px;">×”××¤×ª×—×•×ª × ×©××¨×™× ×¨×§ ×‘×“×¤×“×¤×Ÿ ×©×œ×š (Local Storage) ×•×œ× × ×©×œ×—×™× ×œ×©×¨×ª×™× ×—×™×¦×•× ×™×™×</p>
            </div>
            
            <div class="upload-section" id="uploadSection">
                <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ“¸</div>
                <h3 style="margin-bottom: 15px; color: #2c3e50;">×”×¢×œ×” ×ª××•× ×” ×©×œ ×”××•×›×œ</h3>
                <p style="color: #666; margin-bottom: 20px;">×’×¨×•×¨ ×•×©×—×¨×¨ ×ª××•× ×” ×›××Ÿ, ××• ×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨</p>
                <input type="file" id="imageInput" accept="image/*" />
                <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
                    ×‘×—×¨ ×ª××•× ×”
                </button>
            </div>
            
            <div class="main-card" style="margin-top: 25px;">
                <label for="additionalInfo" style="display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50; font-size: 1.1rem;">
                    â„¹ï¸ ××™×“×¢ × ×•×¡×£ ×¢×œ ×”××•×›×œ (××•×¤×¦×™×•× ×œ×™):
                </label>
                <textarea 
                    id="additionalInfo" 
                    placeholder="×œ×“×•×’××”: ×–×” ×›×¨×™×š ×¢× 2 ×¤×¨×•×¡×•×ª ×œ×—×, ×—×–×” ×¢×•×£, ×—×¡×” ×•×¢×’×‘× ×™×™×”. ×”×›××•×ª ×”×™× ×›-200 ×’×¨×..."
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; min-height: 100px; font-family: inherit; resize: vertical; box-sizing: border-box;"
                ></textarea>
                <p style="font-size: 0.9rem; color: #666; margin-top: 10px; line-height: 1.5;">
                    ğŸ’¡ ×”×•×¡×£ ××™×“×¢ ×¢×œ ×”×›××•×ª, ×¡×•×’ ×”××•×›×œ, ××¨×›×™×‘×™× × ×•×¡×¤×™× ×•×›×•' ×›×“×™ ×œ×§×‘×œ × ×™×ª×•×— ××“×•×™×§ ×™×•×ª×¨. 
                    ×”×©×“×” ×”×–×” ×ª××™×“ ×’×œ×•×™ - ×ª×•×›×œ ×œ×”×–×™×Ÿ ××™×“×¢ ×œ×¤× ×™ ××• ××—×¨×™ ×”×¢×œ××ª ×”×ª××•× ×”.
                </p>
            </div>
            
            <div class="preview-section" id="previewSection" style="display: none;">
                <img id="previewImage" class="preview-image" alt="×ª×¦×•×’×” ××§×“×™××”" />
                <br />
                <button class="analyze-btn" id="analyzeBtn" onclick="analyzeImage()">
                    ğŸ” × ×ª×— ×ª××•× ×”
                </button>
            </div>
            
            <div class="loading" id="loading" style="display: none;">
                <div style="font-size: 3rem; margin-bottom: 15px;">â³</div>
                <p>×× ×ª×— ××ª ×”×ª××•× ×”... ×–×” ×™×›×•×œ ×œ×§×—×ª ×›××” ×©× ×™×•×ª</p>
            </div>
            
            <div class="error" id="error" style="display: none;"></div>
            
            <div class="results-section" id="resultsSection" style="display: none;">
                <h3>ğŸ“Š ×ª×•×¦××•×ª × ×™×ª×•×—</h3>
                <div class="nutrition-grid" id="nutritionGrid"></div>
                <div class="ai-description" id="aiDescription"></div>
                <div class="save-section">
                    <button class="save-btn" onclick="saveToGoogleSheets()">
                        ğŸ’¾ ×©××•×¨ ×œ-Google Sheets
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJnimpbNPlmzX5mv43iDNgmg8CNHHS2w8Jqt6fdPNMiFuvQc0THDJU3i9eaQc4g0Vb/exec';
        
        let currentImageFile = null;
        let analysisResults = null;
        
        // Load API keys and settings from localStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedProvider = localStorage.getItem('ai_provider') || 'gemini';
            document.getElementById('providerSelect').value = savedProvider;
            toggleProviderFields();
            
            const savedGeminiKey = localStorage.getItem('gemini_api_key');
            if (savedGeminiKey) {
                document.getElementById('geminiApiKey').value = savedGeminiKey;
            }
            
            const savedOpenAIKey = localStorage.getItem('openai_api_key');
            if (savedOpenAIKey) {
                document.getElementById('openaiApiKey').value = savedOpenAIKey;
            }
            
            const savedModel = localStorage.getItem('openai_model') || 'gpt-4o-mini';
            if (savedModel) {
                document.getElementById('modelSelect').value = savedModel;
            }
            
            // Setup file input
            document.getElementById('imageInput').addEventListener('change', handleFileSelect);
            
            // Setup drag and drop
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.addEventListener('dragover', handleDragOver);
            uploadSection.addEventListener('drop', handleDrop);
            uploadSection.addEventListener('dragleave', handleDragLeave);
            
            // Save model when changed
            document.getElementById('modelSelect').addEventListener('change', function() {
                localStorage.setItem('openai_model', this.value);
            });
            
            // Save provider when changed
            document.getElementById('providerSelect').addEventListener('change', function() {
                localStorage.setItem('ai_provider', this.value);
            });
        });
        
        function toggleProviderFields() {
            const provider = document.getElementById('providerSelect').value;
            if (provider === 'gemini') {
                document.getElementById('geminiSection').style.display = 'block';
                document.getElementById('openaiSection').style.display = 'none';
            } else {
                document.getElementById('geminiSection').style.display = 'none';
                document.getElementById('openaiSection').style.display = 'block';
            }
        }
        
        function saveApiKey() {
            const provider = document.getElementById('providerSelect').value;
            
            if (provider === 'gemini') {
                const geminiKey = document.getElementById('geminiApiKey').value.trim();
                if (geminiKey) {
                    localStorage.setItem('gemini_api_key', geminiKey);
                    localStorage.setItem('ai_provider', 'gemini');
                    alert('âœ… ××¤×ª×— Gemini × ×©××¨ ×‘×”×¦×œ×—×”!');
                } else {
                    alert('âŒ ×× × ×”×›× ×¡ ××¤×ª×— Gemini API');
                }
            } else {
                const openaiKey = document.getElementById('openaiApiKey').value.trim();
                const model = document.getElementById('modelSelect').value;
                if (openaiKey) {
                    localStorage.setItem('openai_api_key', openaiKey);
                    localStorage.setItem('openai_model', model);
                    localStorage.setItem('ai_provider', 'openai');
                    alert('âœ… ××¤×ª×— OpenAI ×•×”××•×“×œ × ×©××¨×• ×‘×”×¦×œ×—×”!');
                } else {
                    alert('âŒ ×× × ×”×›× ×¡ ××¤×ª×— OpenAI API');
                }
            }
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                displayPreview(file);
            } else {
                alert('âŒ ×× × ×‘×—×¨ ×§×•×‘×¥ ×ª××•× ×” ×ª×§×™×Ÿ');
            }
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('uploadSection').classList.add('dragover');
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('uploadSection').classList.remove('dragover');
        }
        
        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('uploadSection').classList.remove('dragover');
            
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                displayPreview(file);
            } else {
                alert('âŒ ×× × ×‘×—×¨ ×§×•×‘×¥ ×ª××•× ×” ×ª×§×™×Ÿ');
            }
        }
        
        function displayPreview(file) {
            currentImageFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewSection').style.display = 'block';
                document.getElementById('resultsSection').style.display = 'none';
                document.getElementById('error').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        async function analyzeImage() {
            const provider = document.getElementById('providerSelect').value || localStorage.getItem('ai_provider') || 'gemini';
            
            if (!currentImageFile) {
                showError('âŒ ×× × ×‘×—×¨ ×ª××•× ×” ×ª×—×™×œ×”');
                return;
            }
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            
            try {
                if (provider === 'gemini') {
                    await analyzeWithGemini();
                } else {
                    await analyzeWithOpenAI();
                }
            } catch (error) {
                console.error('Error analyzing image:', error);
                showError('âŒ ×©×’×™××” ×‘× ×™×ª×•×— ×”×ª××•× ×”: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
            }
        }
        
        async function analyzeWithGemini() {
            const apiKey = localStorage.getItem('gemini_api_key') || document.getElementById('geminiApiKey').value.trim();
            
            if (!apiKey) {
                throw new Error('×× × ×”×›× ×¡ ××¤×ª×— Google Gemini API');
            }
            
            // First, check if API key is valid and get available models
            let availableModels = [];
            try {
                const listResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (!listResponse.ok) {
                    const errorData = await listResponse.json();
                    if (errorData.error?.message?.includes('expired') || errorData.error?.message?.includes('invalid')) {
                        throw new Error('×”××¤×ª×— API ×¤×’ ×ª×•×§×£ ××• ×œ× ×ª×§×™×Ÿ. ×× × ×¦×•×¨ ××¤×ª×— ×—×“×© ×‘-Google AI Studio: https://aistudio.google.com/app/apikey');
                    }
                    throw new Error(errorData.error?.message || '×©×’×™××” ×‘×‘×“×™×§×ª ×”××¤×ª×— API');
                }
                const listData = await listResponse.json();
                availableModels = listData.models?.map(m => m.name.replace('models/', '')) || [];
                console.log('Available models:', availableModels);
            } catch (listError) {
                if (listError.message.includes('×¤×’ ×ª×•×§×£') || listError.message.includes('×œ× ×ª×§×™×Ÿ')) {
                    throw listError;
                }
                console.warn('Could not fetch model list:', listError);
            }
            
            // Convert image to base64
            const base64Image = await fileToBase64(currentImageFile);
            // Remove data:image/...;base64, prefix for Gemini
            const base64Data = base64Image.split(',')[1];
            
            // Get additional information from user
            const additionalInfo = document.getElementById('additionalInfo').value.trim();
            
            // Build the prompt with additional info if provided
            let promptText = `×× × × ×ª×— ××ª ×”×ª××•× ×” ×©×œ ×”××•×›×œ ×•×¡×¤×§ ×”×¢×¨×›×” ××“×•×™×§×ª ×©×œ ×”×¢×¨×›×™× ×”×ª×–×•× ×ª×™×™× ×”×‘××™×:
- ×§×œ×•×¨×™×•×ª (Calories)
- ×—×œ×‘×•×Ÿ (Protein) ×‘×’×¨××™×
- ×©×•××Ÿ (Fat) ×‘×’×¨××™×
- ×¤×—××™××•×ª (Carbs) ×‘×’×¨××™×
- ×¡×™×‘×™× (Fiber) ×‘×’×¨××™× (×× ×¨×œ×•×•× ×˜×™)

×× × ×”×—×–×¨ ××ª ×”×ª×©×•×‘×” ×‘×¤×•×¨××˜ JSON ×¢× ×”××‘× ×” ×”×‘×:
{
  "calories": ××¡×¤×¨,
  "protein": ××¡×¤×¨,
  "fat": ××¡×¤×¨,
  "carbs": ××¡×¤×¨,
  "fiber": ××¡×¤×¨,
  "description": "×ª×™××•×¨ ×§×¦×¨ ×©×œ ×”××•×›×œ"
}

×× ××™× ×š ×‘×˜×•×— ×‘×¢×¨×š ××¡×•×™×, ×”×©×ª××© ×‘×”×¢×¨×›×” ×¡×‘×™×¨×”.`;

            if (additionalInfo) {
                promptText += `\n\n××™×“×¢ × ×•×¡×£ ××”××©×ª××© ×¢×œ ×”××•×›×œ:\n${additionalInfo}\n\n×× × ×”×©×ª××© ×‘××™×“×¢ ×”×–×” ×›×“×™ ×œ×¡×¤×§ × ×™×ª×•×— ××“×•×™×§ ×™×•×ª×¨.`;
            }
            
            // Try different Gemini models - prioritize models that support images
            // Use available models if we got them, otherwise use default list
            const defaultModels = [
                'gemini-1.5-pro-latest',
                'gemini-1.5-flash-latest', 
                'gemini-1.5-pro',
                'gemini-1.5-flash',
                'gemini-pro-vision'
            ];
            
            const modelsToTry = availableModels.length > 0 
                ? availableModels.filter(m => defaultModels.some(dm => m.includes(dm.split('-').slice(0, 2).join('-'))))
                : defaultModels;
            
            if (modelsToTry.length === 0 && availableModels.length > 0) {
                modelsToTry.push(...availableModels.slice(0, 3)); // Try first 3 available models
            }
            
            const modelConfigs = modelsToTry.map(model => ({ model, version: 'v1beta' }));
            let lastError = null;
            
            for (const config of modelConfigs) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/${config.version}/models/${config.model}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    {
                                        text: promptText
                                    },
                                    {
                                        inlineData: {
                                            mimeType: currentImageFile.type,
                                            data: base64Data
                                        }
                                    }
                                ]
                            }]
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorMsg = errorData.error?.message || '×©×’×™××” ×‘× ×™×ª×•×— ×”×ª××•× ×”';
                        
                        // If API key expired, throw immediately
                        if (errorMsg.includes('expired') || errorMsg.includes('invalid') || errorMsg.includes('API key')) {
                            throw new Error('×”××¤×ª×— API ×¤×’ ×ª×•×§×£ ××• ×œ× ×ª×§×™×Ÿ. ×× × ×¦×•×¨ ××¤×ª×— ×—×“×© ×‘-Google AI Studio: https://aistudio.google.com/app/apikey');
                        }
                        
                        lastError = new Error(errorMsg);
                        continue; // Try next model
                    }
                    
                    const data = await response.json();
                    const content = data.candidates[0].content.parts[0].text;
                    
                    // Parse JSON from response
                    let nutritionData;
                    try {
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            nutritionData = JSON.parse(jsonMatch[0]);
                        } else {
                            nutritionData = extractNutritionFromText(content);
                        }
                    } catch (parseError) {
                        nutritionData = extractNutritionFromText(content);
                    }
                    
                    analysisResults = nutritionData;
                    displayResults(nutritionData, content);
                    return; // Success, exit function
                    
                } catch (error) {
                    lastError = error;
                    continue; // Try next model
                }
            }
            
            // If all models failed, try to get list of available models
            try {
                const listResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (listResponse.ok) {
                    const listData = await listResponse.json();
                    const availableModels = listData.models?.map(m => m.name) || [];
                    throw new Error(`×›×œ ×”××•×“×œ×™× × ×›×©×œ×•. ×”××•×“×œ×™× ×”×–××™× ×™×: ${availableModels.join(', ')}. ×©×’×™××” ××—×¨×•× ×”: ${lastError?.message || '×œ× ×™×“×•×¢'}`);
                }
            } catch (listError) {
                // Ignore list error, just throw the original error
            }
            
            // If all models failed, throw the last error with helpful message
            const errorMsg = lastError?.message || '×›×œ ×”××•×“×œ×™× × ×›×©×œ×•';
            throw new Error(`${errorMsg}. ×× × ×•×“× ×©×”××¤×ª×— API ×ª×§×™×Ÿ ×•×©×”×•× ×ª×•××š ×‘× ×™×ª×•×— ×ª××•× ×•×ª. × ×¡×” ×œ×™×¦×•×¨ ××¤×ª×— ×—×“×© ×‘-Google AI Studio.`);
        }
        
        async function analyzeWithOpenAI() {
            const apiKey = localStorage.getItem('openai_api_key') || document.getElementById('openaiApiKey').value.trim();
            const selectedModel = document.getElementById('modelSelect').value || 'gpt-4o-mini';
            
            if (!apiKey) {
                throw new Error('×× × ×”×›× ×¡ ××¤×ª×— OpenAI API');
            }
            
            // Convert image to base64
            const base64Image = await fileToBase64(currentImageFile);
            
            // Get additional information from user
            const additionalInfo = document.getElementById('additionalInfo').value.trim();
            
            // Build the prompt with additional info if provided
            let promptText = `×× × × ×ª×— ××ª ×”×ª××•× ×” ×©×œ ×”××•×›×œ ×•×¡×¤×§ ×”×¢×¨×›×” ××“×•×™×§×ª ×©×œ ×”×¢×¨×›×™× ×”×ª×–×•× ×ª×™×™× ×”×‘××™×:
- ×§×œ×•×¨×™×•×ª (Calories)
- ×—×œ×‘×•×Ÿ (Protein) ×‘×’×¨××™×
- ×©×•××Ÿ (Fat) ×‘×’×¨××™×
- ×¤×—××™××•×ª (Carbs) ×‘×’×¨××™×
- ×¡×™×‘×™× (Fiber) ×‘×’×¨××™× (×× ×¨×œ×•×•× ×˜×™)

×× × ×”×—×–×¨ ××ª ×”×ª×©×•×‘×” ×‘×¤×•×¨××˜ JSON ×¢× ×”××‘× ×” ×”×‘×:
{
  "calories": ××¡×¤×¨,
  "protein": ××¡×¤×¨,
  "fat": ××¡×¤×¨,
  "carbs": ××¡×¤×¨,
  "fiber": ××¡×¤×¨,
  "description": "×ª×™××•×¨ ×§×¦×¨ ×©×œ ×”××•×›×œ"
}

×× ××™× ×š ×‘×˜×•×— ×‘×¢×¨×š ××¡×•×™×, ×”×©×ª××© ×‘×”×¢×¨×›×” ×¡×‘×™×¨×”.`;

            if (additionalInfo) {
                promptText += `\n\n××™×“×¢ × ×•×¡×£ ××”××©×ª××© ×¢×œ ×”××•×›×œ:\n${additionalInfo}\n\n×× × ×”×©×ª××© ×‘××™×“×¢ ×”×–×” ×›×“×™ ×œ×¡×¤×§ × ×™×ª×•×— ××“×•×™×§ ×™×•×ª×¨.`;
            }
            
            // Call OpenAI Vision API
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: selectedModel,
                    messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: promptText
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: base64Image
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 500
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMessage = errorData.error?.message || '×©×’×™××” ×‘× ×™×ª×•×— ×”×ª××•× ×”';
                    
                    // Check for quota exceeded error
                    if (errorMessage.includes('quota') || errorMessage.includes('billing')) {
                        throw new Error('QUOTA_EXCEEDED: ' + errorMessage);
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Try to parse JSON from the response
                let nutritionData;
                try {
                    // Extract JSON from the response (might be wrapped in markdown code blocks)
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        nutritionData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('×œ× × ××¦× JSON ×‘×ª×©×•×‘×”');
                    }
                } catch (parseError) {
                    // If JSON parsing fails, try to extract numbers from text
                    nutritionData = extractNutritionFromText(content);
                }
                
            analysisResults = nutritionData;
            displayResults(nutritionData, content);
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Remove data:image/...;base64, prefix
                    const base64 = reader.result.split(',')[1];
                    resolve(`data:${file.type};base64,${base64}`);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function extractNutritionFromText(text) {
            // Try to extract numbers from text as fallback
            const caloriesMatch = text.match(/×§×œ×•×¨×™×•×ª[:\s]*(\d+)/i) || text.match(/calories[:\s]*(\d+)/i);
            const proteinMatch = text.match(/×—×œ×‘×•×Ÿ[:\s]*(\d+(?:\.\d+)?)/i) || text.match(/protein[:\s]*(\d+(?:\.\d+)?)/i);
            const fatMatch = text.match(/×©×•××Ÿ[:\s]*(\d+(?:\.\d+)?)/i) || text.match(/fat[:\s]*(\d+(?:\.\d+)?)/i);
            const carbsMatch = text.match(/×¤×—××™××•×ª[:\s]*(\d+(?:\.\d+)?)/i) || text.match(/carbs[:\s]*(\d+(?:\.\d+)?)/i);
            const fiberMatch = text.match(/×¡×™×‘×™×[:\s]*(\d+(?:\.\d+)?)/i) || text.match(/fiber[:\s]*(\d+(?:\.\d+)?)/i);
            
            return {
                calories: caloriesMatch ? parseInt(caloriesMatch[1]) : 0,
                protein: proteinMatch ? parseFloat(proteinMatch[1]) : 0,
                fat: fatMatch ? parseFloat(fatMatch[1]) : 0,
                carbs: carbsMatch ? parseFloat(carbsMatch[1]) : 0,
                fiber: fiberMatch ? parseFloat(fiberMatch[1]) : 0,
                description: text.substring(0, 200)
            };
        }
        
        function displayResults(nutritionData, aiDescription) {
            const grid = document.getElementById('nutritionGrid');
            grid.innerHTML = '';
            
            const items = [
                { label: '×§×œ×•×¨×™×•×ª', value: Math.round(nutritionData.calories || 0), unit: '×§×§"×œ' },
                { label: '×—×œ×‘×•×Ÿ', value: (nutritionData.protein || 0).toFixed(1), unit: '×’×¨×' },
                { label: '×©×•××Ÿ', value: (nutritionData.fat || 0).toFixed(1), unit: '×’×¨×' },
                { label: '×¤×—××™××•×ª', value: (nutritionData.carbs || 0).toFixed(1), unit: '×’×¨×' },
                { label: '×¡×™×‘×™×', value: (nutritionData.fiber || 0).toFixed(1), unit: '×’×¨×' }
            ];
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'nutrition-item';
                div.innerHTML = `
                    <label>${item.label}</label>
                    <div class="value">${item.value} ${item.unit}</div>
                `;
                grid.appendChild(div);
            });
            
            const descriptionDiv = document.getElementById('aiDescription');
            descriptionDiv.innerHTML = `
                <h4>ğŸ“ ×ª×™××•×¨ ×”××•×›×œ:</h4>
                <p>${nutritionData.description || aiDescription || '×œ× ×–××™×Ÿ'}</p>
            `;
            
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            
            // Check if it's a quota exceeded error
            if (message.includes('QUOTA_EXCEEDED') || message.includes('quota') || message.includes('billing')) {
                errorDiv.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong style="font-size: 1.1rem;">âš ï¸ ×—×¨×’×ª ××”××›×¡×” ×©×œ×š ×‘-OpenAI API</strong>
                    </div>
                    <div style="line-height: 1.8; text-align: right;">
                        <p><strong>××” ×œ×¢×©×•×ª:</strong></p>
                        <ol style="margin-right: 20px; margin-top: 10px;">
                            <li>×”×™×›× ×¡ ×œ-<a href="https://platform.openai.com/account/billing" target="_blank" style="color: #1976D2; text-decoration: underline;">OpenAI Billing</a> ×•×‘×“×•×§ ××ª ×”××›×¡×” ×©×œ×š</li>
                            <li>×”×•×¡×£ ×××¦×¢×™ ×ª×©×œ×•× ×‘-<a href="https://platform.openai.com/account/billing/payment-methods" target="_blank" style="color: #1976D2; text-decoration: underline;">Payment Methods</a></li>
                            <li>×‘×“×•×§ ××ª ×”×ª×•×›× ×™×ª ×©×œ×š ×‘-<a href="https://platform.openai.com/account/usage" target="_blank" style="color: #1976D2; text-decoration: underline;">Usage</a></li>
                            <li>×× ××ª×” ××©×ª××© ×‘-GPT-4, ×©×§×•×œ ×œ×¢×‘×•×¨ ×œ-GPT-3.5-turbo (×–×•×œ ×™×•×ª×¨)</li>
                        </ol>
                        <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                            <strong>×”×¢×¨×” ×—×©×•×‘×”:</strong> ×’× ×× ×™×© ×œ×š ChatGPT Plus ($20/×—×•×“×©), 
                            ×”×©×™××•×© ×‘-API × ×¤×¨×“ ×•×“×•×¨×© ×××¦×¢×™ ×ª×©×œ×•× × ×•×¡×£. 
                            ×œ××—×¨ ×”×•×¡×¤×ª ×××¦×¢×™ ×ª×©×œ×•× ×œ-API, ×ª×§×‘×œ ×§×¨×“×™×˜ ×—×™× ××™ ×©×œ $5 ×œ×©×™××•×©.
                        </p>
                        <p style="margin-top: 10px; color: #1976D2; font-size: 0.9rem;">
                            <strong>ğŸ’¡ ×˜×™×¤:</strong> ×”×©×ª××© ×‘-GPT-4o-mini (×–×•×œ ×™×•×ª×¨) ×›×“×™ ×œ×—×¡×•×š ×›×¡×£!
                        </p>
                    </div>
                `;
            } else {
                errorDiv.textContent = message;
            }
            
            errorDiv.style.display = 'block';
        }
        
        async function saveToGoogleSheets() {
            if (!analysisResults) {
                alert('âŒ ××™×Ÿ × ×ª×•× ×™× ×œ×©××™×¨×”');
                return;
            }
            
            try {
                // Get today's date
                const today = new Date();
                const dateStr = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
                
                // Prepare data for Google Sheets
                const nutritionData = [
                    dateStr,
                    Math.round(analysisResults.calories || 0),
                    (analysisResults.fat || 0).toFixed(1),
                    (analysisResults.carbs || 0).toFixed(1),
                    (analysisResults.protein || 0).toFixed(1),
                    (analysisResults.fiber || 0).toFixed(1),
                    0 // Steps (not applicable for meal recognition)
                ];
                
                // Save to Google Sheets
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addNutrition',
                        data: nutritionData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×” ×œ-Google Sheets!');
                } else {
                    throw new Error(result.error || '×©×’×™××” ×‘×©××™×¨×”');
                }
                
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                alert('âŒ ×©×’×™××” ×‘×©××™×¨×” ×œ-Google Sheets: ' + error.message);
            }
        }
    </script>
</body>
</html>

